BX.namespace("BX.Sale.OrderAjaxComponent.Maps"),function(){"use strict";BX.Sale.OrderAjaxComponent.Maps={init:function(t){return this.context=t||{},this.pickUpOptions=this.context.options.pickUpMap,this.propsOptions=this.context.options.propertyMap,this.maxWaitTimeExpired=!1,this},initializePickUpMap:function(t){ymaps&&(this.pickUpMap=new ymaps.Map("pickUpMap",{center:t?[t.GPS_N,t.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom}),this.pickUpMap.behaviors.disable("scrollZoom"),this.pickUpMap.events.add("click",BX.delegate(function(){this.pickUpMap.balloon.isOpen()&&this.pickUpMap.balloon.close()},this)))},pickUpMapFocusWaiter:function(){this.pickUpMap&&this.pickUpMap.geoObjects?this.setPickUpMapFocus():setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)},setPickUpMapFocus:function(){var t,e,s;(t=this.pickUpMap.geoObjects.getBounds())&&t.length&&(e=t[1][0]-t[0][0],s=t[1][1]-t[0][1],t[0][0]-=e/10,t[0][1]-=s/10,t[1][0]+=e/10,t[1][1]+=s/10,this.pickUpMap.setBounds(t,{checkZoomRange:!0}))},showNearestPickups:function(t,e){if(ymaps){var s=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto",i=this.pickUpOptions.geoLocationMaxTime||5e3;ymaps.geolocation.get({provider:s,timeOut:i}).then(BX.delegate(function(e){this.maxWaitTimeExpired||(this.maxWaitTimeExpired=!0,e.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon"),this.pickUpMap.geoObjects.add(e.geoObjects),t(e))},this),BX.delegate(function(){this.maxWaitTimeExpired||(this.maxWaitTimeExpired=!0,e())},this))}},buildBalloons:function(t){if(ymaps){var e=this;this.pickUpPointsJSON=[];for(var s=0;s<t.length;s++){var i=this.getStoreInfoHtml(t[s]);this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[t[s].GPS_N,t[s].GPS_S]},properties:{storeId:t[s].ID}});var o=new ymaps.Placemark([t[s].GPS_N,t[s].GPS_S],{hintContent:BX.util.htmlspecialchars(t[s].TITLE)+"<br />"+BX.util.htmlspecialchars(t[s].ADDRESS),storeTitle:t[s].TITLE,storeBody:i,id:t[s].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonContentLayout:ymaps.templateLayoutFactory.createClass('<h3>{{ properties.storeTitle }}</h3>{{ properties.storeBody|raw }}<br /><a class="btn btn-sm btn-default" data-store="{{ properties.id }}">{{ properties.text }}</a>',{build:function(){this.constructor.superclass.build.call(this);var t=document.querySelector("a[data-store]");t&&BX.bind(t,"click",this.selectStoreByClick)},clear:function(){var t=document.querySelector("a[data-store]");t&&BX.unbind(t,"click",this.selectStoreByClick),this.constructor.superclass.clear.call(this)},selectStoreByClick:function(t){var s=t.target||t.srcElement;e.pickUpMap.container.isFullscreen()&&e.pickUpMap.container.exitFullscreen(),e.context.selectStore(s.getAttribute("data-store")),e.context.clickNextAction(t),e.pickUpMap.balloon.close()}})});BX("BUYER_STORE").value===t[s].ID&&o.options.set("preset","islands#redDotIcon"),this.pickUpMap.geoObjects.add(o)}}},selectBalloon:function(t){this.pickUpMap&&this.pickUpMap.geoObjects&&this.pickUpMap.geoObjects.each(BX.delegate(function(e){e.properties.get("id")&&e.options.unset("preset"),e.properties.get("id")===t&&(e.options.set({preset:"islands#redDotIcon"}),this.pickUpMap.panTo([e.geometry.getCoordinates()]))},this))},pickUpFinalAction:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){var t=BX("BUYER_STORE");this.pickUpMap.geoObjects.each(function(e){e.properties.get("id")===t.value?e.options.set({preset:"islands#redDotIcon"}):parseInt(e.properties.get("id"))>0&&e.options.unset("preset")})}},initializePropsMap:function(t){ymaps&&(this.propsMap=new ymaps.Map("propsMap",{center:[t.lat,t.lon],zoom:t.zoom}),this.propsMap.behaviors.disable("scrollZoom"),this.propsMap.events.add("click",BX.delegate(function(t){var e,s=t.get("coords");0===this.propsMap.geoObjects.getLength()?((e=new ymaps.Placemark([s[0],s[1]],{},{draggable:!0,preset:"islands#redDotIcon"})).events.add(["parentchange","geometrychange"],function(){var t,s,i,o,p=BX("orderDescription"),a=e.geometry.getCoordinates();p&&(-1===(t=p.value.indexOf(BX.message("SOA_MAP_COORDS")+":"))?p.value=BX.message("SOA_MAP_COORDS")+": "+a[0]+", "+a[1]+"\r\n"+p.value:(o=BX.message("SOA_MAP_COORDS")+": "+a[0]+", "+a[1],s=p.value.substring(0,t),i=p.value.substring(t+o.length),p.value=s+o+i))}),this.propsMap.geoObjects.add(e)):this.propsMap.geoObjects.get(0).geometry.setCoordinates([s[0],s[1]])},this)))},canUseRecommendList:function(){return this.pickUpPointsJSON&&this.pickUpPointsJSON.length},getRecommendedStoreIds:function(t){if(!t)return[];var e=[],s=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var i=0;i<s;i++){var o=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON}),p=o.getClosestTo(t),a=p.properties.get("storeId");this.storeQueryResult[a]=p,e.push(a),this.pickUpPointsJSON.splice(o.indexOf(p),1)}return e},getDistance:function(t,e){if(!t||!e)return!1;var s=this.storeQueryResult[e],i=ymaps.coordSystem.geo.getDistance(t.geometry.getCoordinates(),s.geometry.getCoordinates());return i=Math.round(i/100)/10},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(t){var e="";return t.ADDRESS&&(e+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(t.ADDRESS)+"<br />"),t.PHONE&&(e+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(t.PHONE)+"<br />"),t.SCHEDULE&&(e+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(t.SCHEDULE)+"<br />"),t.DESCRIPTION&&(e+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(t.DESCRIPTION)+"<br />"),e}}}();