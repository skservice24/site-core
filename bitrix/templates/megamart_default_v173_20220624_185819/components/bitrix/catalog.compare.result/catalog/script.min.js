BX.namespace("BX.Iblock.Catalog"),BX.Iblock.Catalog.CompareClass=function(){var t=function(t){this.errorCode=0,this.obCompare=null,this.node={},this.config={name:"CATALOG_COMPARE_LIST",iblockId:null},this.items=[],this.obItems=[],this.obScrolls=[],this.obTables=[],this.obScrollbarParams={},this.obScrollActive=!1,this.scrollTimer,this.hoverStateChangeForbidden=!1,"object"==typeof t&&(this.visual=t.VISUAL,this.config.name=t.CONFIG.NAME,this.config.iblockId=t.CONFIG.IBLOCK_ID,this.ajaxUrl=t.CONFIG.TEMPLATE_FOLDER+"/ajax.php",this.iMinColumsCount=parseInt(t.CONFIG.MIN_COLUMNS_COUNT,10),this.items=t.ITEMS,this.useFavorite=t.USE_FAVORITE&&void 0!==RS.Favorite),this.isTouchDevice=BX.hasClass(document.documentElement,"bx-touch"),this.breakpoints={xxs:0,xs:380,sm:576,md:768,lg:992,xl:1200},0===this.errorCode&&BX.ready(BX.delegate(this.init,this)),this.obCompare=BX(this.visual.ID),BX.addCustomEvent(window,"OnCompareSort",BX.proxy(this.compareSort,this))};return t.prototype.MakeAjaxAction=function(t,e){this.showWait(),BX.ajax.post(t,{ajax_action:"Y",ajax_id:this.visual.ID},BX.proxy(this.reloadResult,this)),e&&BX.PreventDefault(e)},t.prototype.reloadResult=function(t){this.obCompare.innerHTML=t,this.init(),this.closeWait(),BX.onCustomEvent("OnCompareChange")},t.prototype.init=function(){var t,e,o;if(this.obTable=BX(this.visual.TABLE),this.obCompare||(this.errorCode=-1),this.showWait(),this.node.scrollItems=this.obCompare.querySelector('[data-entity="scroll-items"]'),this.node.scrollItemsTop=this.obCompare.querySelector('[data-entity="scroll-items-top"]'),this.node.topPanel=this.obCompare.querySelector('[data-entity="top-panel"]'),this.node.scrollProps=this.obCompare.querySelector('[data-entity="scroll-props"]'),this.node.scrollItems&&this.obScrolls.push(this.node.scrollItems),this.node.scrollItemsTop&&this.obScrolls.push(this.node.scrollItemsTop),this.node.scrollItems&&this.obScrolls.push(this.node.scrollProps),this.obItems=[],this.node.scrollItems){var i=this.node.scrollItems.querySelectorAll('[data-entity="compare-item"]');for(t in i)i.hasOwnProperty(t)&&this.obItems.push(i[t])}for(t in this.obItems)this.initItem(this.obItems[t]);if(this.node.topPanel){this.checkTopPanels(),BX.bind(window,"scroll",BX.proxy(this.checkTopPanels,this));i=this.node.topPanel.querySelectorAll('[data-entity="compare-item"]');for(t in i)i.hasOwnProperty(t)&&this.initItem(i[t])}if(this.obScrolls.length>0)for(t=0;t<this.obScrolls.length;t++)BX.bind(this.obScrolls[t],"scroll",BX.proxy(function(){var t=BX.proxy_context;if(0==this.obScrollActive&&(this.obScrollActive=t),t==this.obScrollActive){if(clearTimeout(this.scrollTimer),this.obScrolls.length>0)for(var e=0;e<this.obScrolls.length;e++)this.obScrolls[e].scrollLeft=t.scrollLeft;this.scrollTimer=setTimeout(BX.proxy(function(){this.obScrollActive=!1},this),100)}},this));var r=this.obCompare.querySelectorAll('[data-entity="compare-table"]');for(t in r)r.hasOwnProperty(t)&&this.obTables.push(r[t]);if(this.obTables.length)for(t in this.obTables)for(e=0;e<this.obTables[t].children.length;e++){var s=this.obTables[t].children.item(e);for(o=0;o<s.children.length;o++)BX.bind(s.children.item(o),"mouseenter",BX.proxy(this.tableRowHoverOn,this)),BX.bind(s.children.item(o),"mouseleave",BX.proxy(this.tableRowHoverOff,this))}this.onResize(),BX.bind(window,"resize",BX.proxy(this.onResize,this)),this.obTable&&new BX.easing({duration:1e3,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.linear),step:BX.proxy(function(t){this.obTable.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){this.closeWait(),this.obTable.removeAttribute("style")},this)}).animate()},t.prototype.initItem=function(t){var e=t.getAttribute("data-product-id");this.compareItemDragInit(t.parentNode),BX.bind(t,"mouseenter",BX.proxy(this.itemHoverOn,this)),BX.bind(t,"mouseleave",BX.proxy(this.itemHoverOff,this)),this.useFavorite&&(obFavorite=t.querySelector('[data-entity="compare-item-favorite"]'),obFavorite&&(BX.bind(obFavorite,"click",BX.proxy(this.favorite.bind(this,e),this)),BX.addCustomEvent("change.rs_favorite",BX.proxy(this.checkFavorite.bind(this,obFavorite,e),this)),this.checkFavorite(obFavorite,e)))},t.prototype.compareSort=function(){var t={action:"compare-sort",ITEMS:[]};if(this.node.scrollItems){var e=this.node.scrollItems.querySelectorAll('[data-entity="compare-item"]');for(i in e)if(e.hasOwnProperty(i)){var o=this.obItems.indexOf(e[i]);t.ITEMS.push(this.items[o])}}this.sendRequest(t)},t.prototype.sendRequest=function(t){var e={siteId:this.siteId,AJAX:"Y",NAME:this.config.name,IBLOCK_ID:this.config.iblockId};BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:BX.merge(e,t),onsuccess:BX.delegate(function(e){this.showAction(e,t)},this)})},t.prototype.showAction=function(t,e){if(e)switch(e.action){case"compare-sort":this.compareSortResult(t)}},t.prototype.compareSortResult=function(){},t.prototype.onResize=function(){var t=-1,e={};for(var o in e[this.breakpoints.xxs]={items:2},e[this.breakpoints.md]={items:3},e[this.breakpoints.lg]={items:4},e[this.breakpoints.xl]={items:5},e)(o=Number(o))<=this.getWidth()&&o>t&&(t=o);var i=this.obCompare.querySelectorAll('[data-entity="compare-content"]');for(var r in i)if(i.hasOwnProperty(r)){100*this.obItems.length/e[t].items>100?i[r].style.width=100*this.obItems.length/e[t].items+"%":i[r].style.width="";var s=i[r].querySelectorAll('[data-entity="compare-items"], [data-entity="compare-table"] > tbody > tr');if(s.length)for(var a in s)if(s.hasOwnProperty(a))for(var n=0;n<s[a].children.length;n++){var l=s[a].children.item(n);n+1>e[t].items&&BX.hasClass(l,"compare-page__placeholder")?l.style.display="none":l.style.display=""}}},t.prototype.onScroll=function(){},t.prototype.checkTopPanels=function(t){var e,o,i=BX.GetWindowScrollPos().scrollTop;this.node.topPanel&&(e=BX.pos(this.node.scrollItems).bottom-50,o=BX.pos(this.node.scrollProps).bottom,(this.isTouchDevice&&i<this.lastScrollTop||!this.isTouchDevice)&&i>e&&i<o-this.node.topPanel.offsetHeight-this.getPanelOffset()?this.showTopPanel():BX.hasClass(this.node.topPanel,"active")&&this.hideTopPanel()),this.lastScrollTop=i},t.prototype.showTopPanel=function(){BX.addClass(this.node.topPanel,"active"),this.node.topPanel.style.top=this.getPanelOffset()+"px"},t.prototype.hideTopPanel=function(){BX.removeClass(this.node.topPanel,"active"),this.node.topPanel.style.top=""},t.prototype.getPanelOffset=function(){var t=0;if(1==RS.Options.fixingCompactHeader){var e=document.querySelector(RS.Options.compactHeaderSelector);null!=e&&(t+=BX.firstChild(e).offsetHeight)}return t},t.prototype.showWait=function(){BX.addClass(this.obTable,"overlay is-loading")},t.prototype.closeWait=function(){BX.removeClass(this.obTable,"overlay is-loading")},t.prototype.compareItemDragStart=function(){var t=document.body.appendChild(document.createElement("DIV"));return t.style.position="absolute",t.style.zIndex=1100,t.className="bx-drag-object",t.innerHTML=this.innerHTML,t.style.width=this.clientWidth+"px",this.__dragCopyDiv=t,!0},t.prototype.compareItemDrag=function(t,e,o){var i,r=this.__dragCopyDiv,s=this.__currentDest;if(null==this.__dragOffset&&(this.__dragOffset={left:this.__bxpos[0]-t,top:this.__bxpos[1]-e}),r.style.left=t+this.__dragOffset.left+"px",r.style.top=e+this.__dragOffset.top+"px",i=null==s?this:s){var a=BX.findChildren(i.parentNode,{},!1).indexOf(i),n=BX.findParent(i,{attribute:{"data-entity":"compare-page"}}).querySelectorAll('[data-entity="compare-items"], [data-entity="compare-table"] > tbody > tr:not([data-entity="compare-prop-name"])');if(n.length)for(var l in n)if(n.hasOwnProperty(l))for(var h=0;h<n[l].children.length;h++)n[l].children.item(h).style.opacity="",n[l].children.item(h).style.opacity=h==a?"":"0.5"}return!0},t.prototype.compareItemDragStop=function(t,e,o){this.className=this.className.replace(/\s*bx-grid-drag-source/gi,""),this.__dragCopyDiv.parentNode.removeChild(this.__dragCopyDiv),this.__dragCopyDiv=null,this.__dragOffset=null;var i=BX.findParent(this,{attribute:{"data-entity":"compare-page"}}).querySelectorAll('[data-entity="compare-items"], [data-entity="compare-table"] > tbody > tr:not([data-entity="compare-prop-name"])');if(i.length)for(var r in i)if(i.hasOwnProperty(r))for(var s=0;s<i[r].children.length;s++)i[r].children.item(s).style.opacity="";return!0},t.prototype.compareItemDragHover=function(t,e,o){this.__currentDest=this!=t?t:null},t.prototype.compareItemDragOut=function(t,e,o){},t.prototype.compareItemDestDragFinish=function(t,e,o,i){var r=BX.findChildren(t.parentNode),s=r.indexOf(t),a=r.indexOf(this),n=BX.pos(this),l=BX.findParent(this,{attribute:{"data-entity":"compare-page"}});BX.removeClass(this,"is-hover");var h=l.querySelectorAll('[data-entity="compare-items"], [data-entity="compare-table"] > tbody > tr:not([data-entity="compare-prop-name"])');if(h.length)for(var c in h)if(h.hasOwnProperty(c)){var p=h[c].children.item(s),d=h[c].children.item(a);p&&d&&(e-n.left<n.width/2?d.parentNode.insertBefore(p,d):d.parentNode.insertBefore(p,d.nextSibling))}BX.onCustomEvent("OnCompareSort")},t.prototype.compareItemDragInit=function(t){this.isTouchDevice||null==t.onbxdragstart&&(t.onbxdragstart=this.compareItemDragStart,t.onbxdragstop=this.compareItemDragStop,t.onbxdrag=this.compareItemDrag,t.onbxdraghover=this.compareItemDragHover,t.onbxdraghout=this.compareItemDragOut,t.onbxdestdragfinish=this.compareItemDestDragFinish,jsDD.registerObject(t),jsDD.registerDest(t))},t.prototype.getWidth=function(){return BX.GetWindowSize().innerWidth},t.prototype.tableRowHoverOn=function(t){var e=BX.proxy_context,o=[].slice.call(e.parentNode.children),i=2*Math.trunc(o.indexOf(e)/2);BX.addClass(o[i],"hover"),BX.addClass(o[i+1],"hover"),BX.PreventDefault(t)},t.prototype.tableRowHoverOff=function(t){var e=BX.proxy_context,o=[].slice.call(e.parentNode.children),i=2*Math.trunc(o.indexOf(e)/2);BX.removeClass(o[i],"hover"),BX.removeClass(o[i+1],"hover"),BX.PreventDefault(t)},t.prototype.itemHoverOn=function(t){var e=BX.proxy_context;clearTimeout(this.hoverTimer),e.style.height=getComputedStyle(e).height,BX.addClass(e,"hover"),BX.PreventDefault(t)},t.prototype.itemHoverOff=function(t){if(!this.hoverStateChangeForbidden){var e=BX.proxy_context;BX.removeClass(e,"hover"),e.style.height="",BX.PreventDefault(t)}},t.prototype.favorite=function(t,e){BX.PreventDefault(e),RS.Favorite.request(t)},t.prototype.checkFavorite=function(t,e){if(t){var o=t.querySelector('[data-entity="favorite-title"]');BX.util.in_array(e,RS.Favorite.getItems())?(BX.addClass(t,"checked"),o&&(o.innerHTML=BX.message("BTN_FAVORITE_DEL"))):(BX.removeClass(t,"checked"),o&&(o.innerHTML=BX.message("BTN_FAVORITE_ADD")))}},t}();